services:
  tfm-postgres-db:
    image: postgres:17
    container_name: tfm-postgres-db
    restart: unless-stopped

    env_file:
      - .env

    ports:
      - "${DB_PORT}:5432"

    volumes:
      - pgdata:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"] # Command to check DB status
      interval: 5s     # How often to run the check
      timeout: 5s      # How long to wait for the command to succeed
      retries: 10      # How many times to retry before marking as unhealthy
      start_period: 30s

  db-restore:
    image: postgres:17
    container_name: docker-db-restore

    environment:
      PGHOST: "tfm-postgres-db"
      PGPASSWORD: "${POSTGRES_PASSWORD}"
      PGUSER: "${POSTGRES_USER}"
      PGDATABASE: "${POSTGRES_DB}"
      BAK_FILE: "${DUMP_FILE}"
    
    volumes:
      - ./adventure_works_dw_backup.bak:${DUMP_FILE}
      - ./restore_on_startup.sh:/restore_on_startup.sh

    depends_on:
      tfm-postgres-db:
        condition: service_healthy

    command: ["/bin/sh", "-c", "/restore_on_startup.sh"]

volumes:
  pgdata: